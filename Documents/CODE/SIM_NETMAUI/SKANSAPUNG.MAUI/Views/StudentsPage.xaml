<?xml version="1.0" encoding="utf-8" ?>
<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             xmlns:viewmodel="clr-namespace:SKANSAPUNG.MAUI.ViewModels"
             xmlns:model="clr-namespace:SKANSAPUNG.MAUI.Models"
             x:Class="SKANSAPUNG.MAUI.Views.StudentsPage"
             x:DataType="viewmodel:StudentsViewModel"
             Title="{Binding Title}">
    <ContentPage.ToolbarItems>
        <ToolbarItem Text="Sync" Command="{Binding SyncStudentsCommand}" />
    </ContentPage.ToolbarItems>
    <ContentPage.Behaviors>
        <toolkit:EventToCommandBehavior EventName="Appearing" Command="{Binding LoadStudentsCommand}" />
    </ContentPage.Behaviors>

    <Grid RowDefinitions="Auto,*"
          RowSpacing="10"
          Padding="20">

        <!-- Search Bar -->
        <SearchBar Grid.Row="0"
                   Placeholder="Cari siswa..."
                   Text="{Binding SearchText}"
                   SearchCommand="{Binding SearchCommand}" />

        <!-- Students List -->
        <RefreshView Grid.Row="1"
                     IsRefreshing="{Binding IsRefreshing}"
                     Command="{Binding LoadStudentsCommand}">
            <CollectionView ItemsSource="{Binding Students}"
                            SelectionMode="Single"
                            SelectedItem="{Binding SelectedStudent}"
                            SelectionChangedCommand="{Binding StudentSelectedCommand}"
                            EmptyView="Tidak ada data siswa">
                <CollectionView.ItemTemplate>
                    <DataTemplate x:DataType="model:Student">
                        <Frame Margin="0,5"
                               Style="{StaticResource CardView}">
                            <Grid ColumnDefinitions="Auto,*,Auto"
                                  ColumnSpacing="15">
                                <Ellipse Grid.Column="0"
                                         Fill="{StaticResource Primary}"
                                         HeightRequest="40"
                                         WidthRequest="40"
                                         VerticalOptions="Center">
                                    <Ellipse.Stroke>
                                        <SolidColorBrush Color="{StaticResource Secondary}" />
                                    </Ellipse.Stroke>
                                </Ellipse>
                                <Label Grid.Column="0"
                                       Text="{Binding NamaLengkap, Converter={StaticResource InitialsConverter}}"
                                       TextColor="White"
                                       FontAttributes="Bold"
                                       HorizontalOptions="Center"
                                       VerticalOptions="Center" />
                                <VerticalStackLayout Grid.Column="1"
                                                     VerticalOptions="Center">
                                    <Label Text="{Binding NamaLengkap}"
                                           FontAttributes="Bold" />
                                    <Label Text="{Binding Nis}"
                                           TextColor="{StaticResource Gray600}"
                                           FontSize="12" />
                                    <Label Text="{Binding Email}"
                                           TextColor="{StaticResource Gray600}"
                                           FontSize="12" />
                                </VerticalStackLayout>
                                <Image Grid.Column="2"
                                       Source="arrow_right.png"
                                       HeightRequest="20"
                                       WidthRequest="20"
                                       VerticalOptions="Center" />
                            </Grid>
                        </Frame>
                    </DataTemplate>
                </CollectionView.ItemTemplate>
            </CollectionView>
        </RefreshView>

        <!-- Offline Indicator -->
        <Frame Grid.Row="1"
               BackgroundColor="{StaticResource Warning}"
               Opacity="0.9"
               CornerRadius="10"
               Margin="0,10,0,0"
               Padding="10"
               VerticalOptions="Start"
               HorizontalOptions="Center"
               IsVisible="{Binding IsOnline, Converter={StaticResource InverseBoolConverter}}">
            <Label Text="Mode Offline - Data mungkin tidak terbaru"
                   TextColor="White"
                   FontAttributes="Bold"
                   HorizontalOptions="Center" />
        </Frame>

        <!-- Error Message -->
        <Label Grid.Row="1"
               Text="{Binding ErrorMessage}"
               TextColor="{StaticResource Danger}"
               HorizontalOptions="Center"
               VerticalOptions="Center"
               IsVisible="{Binding ErrorMessage, Converter={StaticResource StringNotEmptyConverter}}" />

        <!-- Activity Indicator -->
        <ActivityIndicator Grid.Row="1"
                           IsRunning="{Binding IsBusy}"
                           IsVisible="{Binding IsBusy}"
                           HorizontalOptions="Center"
                           VerticalOptions="Center" />
    </Grid>
</ContentPage> 